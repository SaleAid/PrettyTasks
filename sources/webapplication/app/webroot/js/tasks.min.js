function toListValidationErrorAll(a){var b="";$.each(a,function(a,c){if($.isArray(c)){$.each(c,function(a,c){b=b+"<br/>"+c})}});return b}function getTaskForEdit(a){return getTaskFromPage(a)}function getTaskFromPage(a){var b={title:$("#"+a).children(".editable").text(),priority:$("#"+a).hasClass("important")?1:0,done:$("#"+a).children(".done").is(":checked"),date:$("#"+a).attr("date"),time:$("#"+a).children(".time").text(),timeEnd:$("#"+a).children(".timeEnd").text(),comment:$("#"+a).children(".commentTask").text()};return b}function getEditElement(a){var b="";switch(a){case"title":b=$("#eTitle");break;case"date":b=$("#eDate");break;case"time":b=$("#eTime");break;case"timeend":b=$("#eTimeEnd");break;case"comment":b=$("#eComment");break}return b}function getCommentDayElement(a){var b="";switch(a){case"comment":b=$("#eCommentDay");break}return b}function mesg(a,b){$.jGrowl.defaults.pool=1;$.jGrowl(a,{glue:"before",position:"custom",theme:b,speed:"fast",life:"3000",animateOpen:{height:"show"},animateClose:{height:"hide"}})}function checkStatus(){$.ajax({type:"POST",data:{date:GLOBAL_CONFIG.date,hash:""},url:"/tasks/checkstatus.json",success:function(a){if(!a.result.success){mesg(a.result.message.message,a.result.message.type)}else{switch(a.result.cause){case"changeDay":mesg(a.result.message.message,a.result.message.type);setTimeout(reload,5e3);break}showErrorConnection(false)}},error:function(a,b,c){if(a.status=="404"||a.status==0){showErrorConnection(true)}else{console.log(a);reload()}}})}function checkLogin(){$.ajax({type:"POST",url:"/checkLogin",success:function(a){if(!a){showErrorConnection(true)}else{showErrorConnection(false)}},error:function(a,b,c){if(a.status=="404"||a.status==0){showErrorConnection(true)}else{console.log(a)}}})}function displayLoadAjax(a){if(!+a){$(".ajaxLoader").addClass("hide")}else{$(".ajaxLoader").removeClass("hide")}}function superAjax(a,b){var c=null;countAJAX++;displayLoadAjax(countAJAX);$.ajax({url:a,type:"POST",data:b,success:function(b,c,d){responseHandler(b.result);countAJAX--;displayLoadAjax(countAJAX);if(typeof _gaq!="undefined"){_gaq.push(["_trackEvent","Tasks",a])}},error:function(a,b,c){if(a.status=="404"||a.status==0){showErrorConnection(true)}else{reload()}}})}function userEvent(a,b){switch(a){case"create":taskCreate(b.title,b.date);break;case"setTitle":taskSetTitle(b.id,b.title);break;case"setDone":taskSetDone(b.id,b.done);break;case"delete":taskDelete(b.id);break;case"dragOnDay":taskDragOnDay(b.id,b.date,b.time);break;case"changeOrders":taskChangeOrders(b.id,b.position);break;case"edit":taskEdit(b.id,b.title,b.priority,b.done,b.date,b.time,b.timeEnd,b.comment);break;case"addDay":taskAddDay(b.date);break;case"deleteDay":taskDeleteDay(b.date);break;case"setRatingDay":taskRatingDay(b.date,b.rating);break;case"getCommentDay":taskGetCommentDay(b.date);break;case"setCommentDay":taskSetCommentDay(b.date,b.comment);break;case"getTasksByType":taskGetTasksByType(b.type);break}}function responseHandler(a){switch(a.action){case"create":onCreate(a);break;case"setTitle":onSetTitle(a);break;case"setDone":onSetDone(a);break;case"delete":onDelete(a);break;case"dragOnDay":onDragOnDay(a);break;case"changeOrders":onChangeOrders(a);break;case"edit":onEdit(a);break;case"addDay":onAddDay(a);break;case"deleteDay":onDeleteDay(a);break;case"setRatingDay":onRatingDay(a);break;case"getCommentDay":onGetCommentDay(a);break;case"setCommentDay":onSetCommentDay(a);break;case"getTasksByType":onGetTasksByType(a);break}}function taskGetTasksByType(a){srvGetTasksByType(a)}function srvGetTasksByType(a){superAjax("/tasks/getTasksByType.json",{type:a})}function scrGetTasksByType(a){switch(a.type){case"future":futureTasks(a.data);break;case"expired":expiredTasks(a.data);break;case"completed":completedTasks(a.data);break}}function onGetTasksByType(a){if(a.success){scrGetTasksByType(a)}else{mesg(a.message.message,a.message.type)}}function futureTasks(a){var b=$('#future ul[date="future"]');b.empty();$.each(a,function(a,c){if(+c.list.length){day=$('<h3 class="day label label-info margin-bottom10" rel="tooltip" title="Кликните для перехода <br/> на '+a+'"><span class="dayDate">'+a+'</span> - <span class="'+c.weelDayStyle+'">'+c.weekDay+"</span></h3>");day.tooltip({placement:"left",delay:{show:500,hide:100}});initDayClick(day.children("span:first"));b.append(day)}$.each(c.list,function(a,c){b.append(AddTask(c));initDelete(b.find("li[id='"+c.Task.id+"'] .deleteTask"));initDone(b.find("li[id='"+c.Task.id+"'] .done"));b.find(" li[id='"+c.Task.id+"'] .editTask").addClass("hide")})});if(!+b.children("li").length){b.siblings(".emptyList").removeClass("hide")}else{b.siblings(".emptyList").addClass("hide")}}function expiredTasks(a){var b=$('#expired ul[date="expired"]');b.empty();if($.isEmptyObject(a)){b.siblings(".emptyList").removeClass("hide")}else{b.siblings(".emptyList").addClass("hide")}$.each(a,function(a,c){if(+c.list.length){day=$('<h3 class="day label label-info margin-bottom10" rel="tooltip" title="Кликните для перехода <br/> на '+a+'"><span class="dayDate">'+a+'</span> - <span class="'+c.weelDayStyle+'">'+c.weekDay+"</span></h3>");day.tooltip({placement:"left",delay:{show:500,hide:100}});initDayClick(day.children("span:first"));b.append(day)}$.each(c.list,function(a,c){b.append(AddTask(c));initDelete(b.find("li[id='"+c.Task.id+"'] .deleteTask"));initDone(b.find("li[id='"+c.Task.id+"'] .done"));b.find(" li[id='"+c.Task.id+"'] .editTask").addClass("hide")})})}function completedTasks(a){var b=$('#completed ul[date="completed"]');var c,d,e,f;b.empty();if($.isEmptyObject(a)){b.siblings(".emptyList").removeClass("hide")}else{b.siblings(".emptyList").addClass("hide")}$.each(a,function(a,g){if(+g.list.length){day=$('<h3 class="day label label-info margin-bottom10" rel="tooltip" title="Кликните для перехода <br/> на '+a+'"><span class="dayDate">'+a+'</span> - <span class="'+g.weelDayStyle+'">'+g.weekDay+"</span></h3>");day.tooltip({placement:"left",delay:{show:500,hide:100}});initDayClick(day.children("span:first"));b.append(day)}$.each(g.list,function(a,g){d=+g.Task.priority?"important":"";e=g.Task.time?g.Task.time.slice(0,-3):"";f=g.Task.timeend?g.Task.timeend.slice(0,-3):"";c='<li class="'+d+'"> '+'<span class="time">'+e+"</span> "+'<span class="timeEnd">'+f+"</span> "+'<span class="title">'+convertToHtml(g.Task.title)+"</span> "+"</li> ";b.append(c)})})}function dayStyle(a){}function srcCountTasks(a){if(a==""){a="planned"}var b=$("ul[date='"+a+"']");var c=b.children("li").length;var d=b.children("li.complete").length;b.siblings(".filter").find("span.all").text(c);b.siblings(".filter").find("span.inProcess").text(c-d);b.siblings(".filter").find("span.completed").text(d);if(!+c){b.siblings(".emptyList").removeClass("hide")}else{b.siblings(".emptyList").addClass("hide")}}function taskSetCommentDay(a,b){srvSetCommentDay(a,b)}function srvSetCommentDay(a,b){superAjax("/days/setComment.json",{date:a,comment:b})}function scrSetCommentDay(a){$("#commentDay").removeAttr("date");$("#eCommentDay").text(null);$("#commentDay").modal("hide")}function onSetCommentDay(a){if(a.success){scrSetCommentDay(a)}else{mesg(a.message.message,a.message.type);scrErrorSetCommentDay(a.errors)}}function arrErrorToList(a){var b="<ul>";if(!+a.length){return}$.each(a,function(a,c){b+=c});b+="</ul>";return b}function scrErrorSetCommentDay(a){$(".errorEdit").removeClass("errorEdit").removeAttr("rel").removeAttr("title").removeAttr("data-original-title").off("tooltip");if(a!==undefined){$.each(a,function(a,b){getCommentDayElement(a).addClass("errorEdit").attr("rel","tooltip").attr("data-original-title",arrErrorToList(b)).tooltip({placement:"right",delay:{show:500,hide:100},template:'<div class="tooltip errorTooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>'})})}}function taskGetCommentDay(a){srvGetCommentDay(a)}function srvGetCommentDay(a){superAjax("/days/getComment.json",{date:a})}function scrGetCommentDay(a){$("#commentDay").attr("date",a.date);$("#eCommentDay").val(a.comment);$("#commentDay").modal("show")}function onGetCommentDay(a){if(!a.success){mesg(a.message.message,a.message.type)}scrGetCommentDay(a.data)}function taskRatingDay(a,b){scrRatingDay(a,b);srvRatingDay(a,b)}function scrRatingDay(a,b){var c=$(".ratingDay[id='"+a+"']");if(+b){c.attr("checked","checked")}else{c.removeAttr("checked")}}function srvRatingDay(a,b){superAjax("/days/setRating.json",{date:a,rating:b})}function onRatingDay(a){if(!a.success){mesg(a.message.message,a.message.type)}}function taskDeleteDay(a){scrDeleteDay(a);srvDeleteDay(a)}function scrDeleteDay(a){$("#"+a).remove();$('#main ul.nav-tabs a[date="'+a+'"]').parent().remove();var b=new Date;activeTab($.datepicker.formatDate("yy-mm-dd",b))}function srvDeleteDay(a){superAjax("/tasks/deleteDay.json",{date:a})}function onDeleteDay(a){if(!a.success){mesg(a.message.message,a.message.type)}}function taskAddDay(a){if(scrAddDay(a)){srvAddDay(a)}}function scrAddDay(a){var b=true;$("#main ul:first li").each(function(){if($(this).children("a").attr("date")==a){b=false}});if(!b){activeTab(a);return false}var c='<div class="tab-pane" id="'+a+'"> '+'<div class="row"> '+'<div class="listTask"> '+'<div class="margin-bottom10"> '+'<img class="print" src="/img/print.png" width="16" height="16"/> '+'<h3 class="label label-info">'+a+'<span class="weekday"></span></h3> '+"</div> "+'<div class="well form-inline"> '+'<div class="input-append"> '+'<input type="text" size="16" class="input-xxlarge createTask" placeholder=" +Добавить задание…"/>'+'<span class="add-on">?</span> '+"</div> "+'<button class="btn createTaskButton"> Добавить </button> '+"</div> "+'<div class="filter"> '+"<span>Фильтр:  </span> "+'<a href="" class="active" data="all">Все</a> '+'<span class="all badge badge-info"> '+"0"+"</span>, "+"  "+'<a href=""  data="inProcess">В Процессе</a> '+'<span class="inProcess badge badge-warning"> '+"0"+"</span>, "+"  "+'<a href="" data="completed">Выполненные</a> '+'<span class="completed badge badge-success"> '+"0"+"</span> "+"</div> "+'<div class="days"> '+'<a href="" data="commentDay">Комментарий</a> '+'<label class="checkbox ratingDay"> '+'<input type="checkbox" date="'+a+'"/> Удачный день '+"</label> "+"</div> "+'<div class="clear"></div> '+'<ul class="sortable connectedSortable ui-helper-reset" date="'+a+'"> '+'<p class="loadContent" align=center> <img src="/img/ajax-loader-content.gif"/></p> '+"</ul> "+"</div> "+"</div> "+"</div> ";$(".tab-content").append(c);var d=$("#main ul.nav-tabs").children("li.userDay").get();var e='<li class="drop userDay"><a href="#'+a+'" data-toggle="tab" date="'+a+'">'+a+'<span class="close">×</span></a></li>';var f=null;d.sort(function(a,b){var c=$(a).find("a").attr("date");var d=$(b).find("a").attr("date");return c<d?-1:c>d?1:0});$.each(d,function(b,c){if(a>$(c).find("a").attr("date")){f=$(c)}});if(f){$(e).insertAfter(f)}else{$(e).insertAfter($("#main ul.nav-tabs li:not('.userDay'):last"))}initTab('#main ul.nav-tabs a[date="'+a+'"]');activeTab(a);return true}function activeTab(a){$("div.active").removeClass("active").removeClass("in");$(".listDay li.active").removeClass("active");$('#main ul.nav-tabs a[date="'+a+'"]').tab("show")}function srvAddDay(a){superAjax("/tasks/getTasksForDay.json",{date:a})}function onAddDay(a){var b=$("ul[date='"+a.data.date+"']");b.after(a.data.emptyList);b.children(".loadContent").remove();b.siblings(".filter").find("span.all").text(a.data.listCount.all);b.siblings(".filter").find("span.inProcess").text(a.data.listCount.all-a.data.listCount.done);b.siblings(".filter").find("span.completed").text(a.data.listCount.done);b.parent().find(".weekday").text(" - "+a.data.weekDay);b.parent().find(".weekday").addClass(a.data.weelDayStyle);initPrintClick(b.parent().find(".print"));if(!$.isEmptyObject(a.data.day)&&+a.data.day[a.data.date][0].Day.rating){$(".ratingDay input[date='"+a.data.date+"']").attr("checked","checked")}$.each(a.data.list,function(a,c){b.append(AddTask(c));initDelete("li[id='"+c.Task.id+"'] .deleteTask");initEditAble("li[id='"+c.Task.id+"'] .editable");initDone("li[id='"+c.Task.id+"'] .done");initEditTask("li[id='"+c.Task.id+"'] .editTask")});initCreateTask($("ul[date='"+a.data.date+"']").parent().find(".createTask"));initCreateTaskButton($("ul[date='"+a.data.date+"']").parent().parent().find(".createTaskButton"));initDrop($("li a[date='"+a.data.date+"']").parent());initSortable("ul[date='"+a.data.date+"'].sortable");initRatingDay(".ratingDay input[date='"+a.data.date+"']");initTabDelte("li a[date='"+a.data.date+"'] .close");initFilter(b.siblings(".filter").children("a"));initCommentDay($("ul[date='"+a.data.date+"']").siblings(".days").children('a[data="commentDay"]'))}function scrDate(a,b){var c=$("li[id='"+a+"']");if(b){c.attr("date",b)}else{c.attr("date","")}}function scrTime(a,b,c){var d=$("li[id='"+a+"']");if(b){d.find(".time").text(b);d.find(".timeEnd").text(c)}else{$(d.find(".time").text(""));$(d.find(".timeEnd").text(""))}}function scrPriority(a,b){var c=$("li[id='"+a+"']");if(+b){c.addClass("impotant")}else{c.removeClass("impotant")}}function scrCommentTask(a,b){$("li[id='"+a+"']").find(".commentTask").text(b)}function taskEdit(a,b,c,d,e,f,g,h){if(+d&&!e){e=GLOBAL_CONFIG.date}srvEdit(a,b,c,d,e,f,g,h)}function onEdit(a){if(a.success){$("#editTask").modal("hide");scrEdit(a.data.Task.id,a.data.Task.title,a.data.Task.priority,a.data.Task.done,a.data.Task.date,a.data.Task.time,a.data.Task.timeend,a.data.Task.comment)}else{mesg(a.message.message,a.message.type);scrErrorEdit(a.errors)}}function scrErrorEdit(a){$(".errorEdit").removeClass("errorEdit").removeAttr("rel").removeAttr("title").removeAttr("data-original-title").off("tooltip");if(a!==undefined){$.each(a,function(a,b){getEditElement(a).addClass("errorEdit").attr("rel","tooltip").attr("data-original-title",arrErrorToList(b)).tooltip({placement:"right",delay:{show:500,hide:100},template:'<div class="tooltip errorTooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>'})})}}function srvEdit(a,b,c,d,e,f,g,h){superAjax("/tasks/editTask.json",{id:a,title:b,priority:c,done:d,date:e,time:f,timeEnd:g,comment:h})}function scrEdit(a,b,c,d,e,f,g,h){scrDragWithTime(a,e,f);scrDate(a,e);scrSetDone(a,d);scrSetTitle(a,b,c);scrTime(a,f,g);scrCommentTask(a,h)}function toSeconds(a){var b=a.split(":");return b[0]*3600+b[1]*60}function scrDragWithTime(a,b,c){var d=$("li[id='"+a+"'].currentTask");var e=d.attr("date");var f=$("li[id='"+a+"']:not(.currentTask)");f.remove();d.removeClass("currentTask");if(!b){var g=$("ul[date='planned']")}else{var g=$("ul[date='"+b+"']")}var h=g.find("li.setTime");var i;var j;var k;var l;var m;var n=$.trim(d.find(".time").text())!=c||d.attr("date")!=b;if(n){if(c){var o=g.children("li.setTime").get();o.sort(function(a,b){var c=toSeconds($(a).find(".time").text());var d=toSeconds($(b).find(".time").text());return c<d?-1:c>d?1:0});$.each(o,function(a,b){if(toSeconds(c)>toSeconds($(b).find(".time").text())){i=$(b).attr("id")}})}d.hide("show",function(){if(i!=a&&i){$(this).insertAfter(g.children("#"+i)).show()}else if(!+i){if(n){if(g.children().length){if(e==b&&!c){}else{$(this).prependTo(g)}}else{$(this).appendTo(g)}}}else{}if(c){$(this).addClass("setTime")}else{$(this).removeClass("setTime")}$(this).attr("date",b);$(this).css({opacity:"1"});$(this).css({display:""});$(this).removeAttr("style");if($(this).children(".editTask").hasClass("hide")){$(this).children(".editTask").removeClass("hide");initEditAble($(this).children(".editable"));initEditTask($(this).children(".editTask"))}if(e!=b){srcCountTasks(e);srcCountTasks(b)}})}}function taskChangeOrders(a,b){scrChangeOrders(a,b);srvChangeOrders(a,b)}function onChangeOrders(a){if(!a.success){mesg(a.message.message,a.message.type)}}function srvChangeOrders(a,b){superAjax("/tasks/changeOrders.json",{id:a,position:b})}function scrChangeOrders(a,b){$("li[id='"+a+"']").removeAttr("style")}function taskDragOnDay(a,b,c){if(b=="planned"){b=""}scrDragOnDay(a,b,c);srvDragOnDay(a,b,c)}function onDragOnDay(a){if(!a.success){mesg(a.message.message+"<hr/>"+toListValidationErrorAll(a.errors),a.message.type)}}function srvDragOnDay(a,b,c){superAjax("/tasks/dragOnDay.json",{id:a,date:b,time:c})}function scrDragOnDay(a,b,c){scrDragWithTime(a,b,c)}function taskDelete(a){scrDelete(a);srvDelete(a)}function onDelete(a){if(!a.success){mesg(a.message.message,a.message.type)}}function srvDelete(a){superAjax("/tasks/deleteTask.json",{id:a})}function scrDelete(a){var b=$("li[id='"+a+"']").attr("date");$("li[id='"+a+"']").remove();srcCountTasks(b)}function taskSetDone(a,b){scrSetDone(a,b);srvSetDone(a,b)}function onSetDone(a){var b=a.data.Task;if(!a.success){mesg(a.message.message,a.message.type);return}if(+b.done&&+b.future){if(b.time==null){b.time=""}taskDragOnDay(b.id,GLOBAL_CONFIG.date,b.time)}else{$("li[id='"+b.id+"'].currentTask").removeClass("currentTask")}}function srvSetDone(a,b){superAjax("/tasks/setDone.json",{id:a,done:b})}function scrSetDone(a,b){$("li[id='"+a+"']").removeAttr("style");var c=$("li[id='"+a+"']").find(".editable");var d=$("li[id='"+a+"']").find(".done");var e=$("li[id='"+a+"']").attr("date");if(+b){d.attr("checked","checked");$("li[id='"+a+"']").addClass("complete")}else{$("li[id='"+a+"']").removeClass("complete");d.removeAttr("checked")}$("li[id='"+a+"']").parent().siblings(".filter").children("a.active").trigger("click");srcCountTasks(e)}function taskSetTitle(a,b){srvSetTitle(a,b)}function onSetTitle(a){scrSetTitle(a.data.Task.id,a.data.Task.title,a.data.Task.priority);if(a.data.Task.time&&$("li[id='"+a.data.Task.id+"']").find(".time").text()!=a.data.Task.time.slice(0,-3)){$("ul[date='"+a.data.Task.date+"']").find("li[id='"+a.data.Task.id+"']").addClass("currentTask");scrDragWithTime(a.data.Task.id,a.data.Task.date,a.data.Task.time);$("li[id='"+a.data.Task.id+"']").find(".time").text(a.data.Task.time.slice(0,-3))}if(!a.success){mesg(a.message.message,a.message.type)}}function srvSetTitle(a,b){superAjax("/tasks/setTitle.json",{id:a,title:b})}function scrSetTitle(a,b,c){var d=$("li[id='"+a+"']").find(".editable");d.text(b);if(c==1){$("li[id='"+a+"']").addClass("important")}else{$("li[id='"+a+"']").removeClass("important")}}function taskCreate(a,b){srvCreate(a,b)}function onCreate(a){if(a.success){scrCreate(a)}else{mesg(a.message.message+"<hr/>"+toListValidationErrorAll(a.errors),a.message.type)}}function srvCreate(a,b){superAjax("/tasks/addNewTask.json",{title:a,date:b})}function scrCreate(a){date=a.data.Task.date;if(a.data.Task.future){date="planned";a.data.Task.date=""}$("ul[date='"+date+"']").append(AddTask(a.data));initDelete("li[id='"+a.data.Task.id+"'] .deleteTask");initEditAble("li[id='"+a.data.Task.id+"'] .editable");initDone("li[id='"+a.data.Task.id+"'] .done");initEditTask("li[id='"+a.data.Task.id+"'] .editTask");$("li[id='"+a.data.Task.id+"']").parent().siblings(".filter").children("a.active").trigger("click");if(a.data.Task.time){$("li[id='"+a.data.Task.id+"']").addClass("currentTask");$("li[id='"+a.data.Task.id+"']").find(".time").text(null);scrDragWithTime(a.data.Task.id,a.data.Task.date,a.data.Task.time);$("li[id='"+a.data.Task.id+"']").find(".time").text(a.data.Task.time.slice(0,-3))}srcCountTasks(date)}function AddTask(a){var b="";var c="";var d="";var e="";var f='<span class="time"></span>';var g='<span class="timeEnd"></span>';if(+a.Task.priority){b="important"}if(+a.Task.done){d=" complete";e=" checked"}if(a.Task.time){c="";f='<span class="time">'+a.Task.time.slice(0,-3)+"</span>";if(a.Task.timeend){g='<span class="timeEnd">'+a.Task.timeend.slice(0,-3)+"</span>"}}taskHtml='<li id ="'+a.Task.id+'" class="'+c+" "+d+" "+b+'" date="'+a.Task.date+'"> \n'+f+"\n"+g+"\n"+'<span class="move"><i class="icon-move"></i></span> \n'+'<input type="checkbox" class="done" '+e+"/> \n"+'<span class="editable ">'+convertToHtml(a.Task.title)+"</span> \n"+'<span class="editTask"><i class="icon-pencil"></i></a></span> \n'+'<span class="deleteTask"><i class=" icon-ban-circle"></i></span> \n'+"</li>";return taskHtml}function initEditAble(a){$(a).editable(function(a,b){var c=$(this).parent().attr("id");userEvent("setTitle",{id:c,title:a});return convertToHtml(a)},{indicator:"<img src='img/indicator.gif'>",placeholder:"",tooltip:"Щелкните чтоб отредактировать этот текст",style:"inherit",data:function(a,b){var c=convertToText(a);return c}})}function initDelete(a){$(a).inlineConfirmation({confirm:"<a href='#'><i class='icon-ok-sign'></i></a>",cancel:"<a href='#'><i class='icon-remove-sign '></i></a>",separator:" ",expiresIn:3,bindsOnEvent:"click",confirmCallback:function(a){a.parent().fadeIn();var b=a.parent().attr("id");userEvent("delete",{id:b})},cancelCallback:function(a){}})}function initDone(a){$(a).on("click",function(){var a=$(this).parent().attr("id");var b=$(this).is(":checked")?1:0;$(this).parent().addClass("currentTask");userEvent("setDone",{id:a,done:b})})}function initRatingDay(a){$(a).on("click",function(){var a=$(this).attr("date");var b=$(this).is(":checked")?1:0;userEvent("setRatingDay",{date:a,rating:b})})}function initEditTask(a){$(a).on("click",function(){var a=getTaskForEdit($(this).parent().attr("id"));var b=$('input:radio[name="priority"]');if(+a.priority){b.filter('[value="1"]').attr("checked",true)}else{b.filter('[value="0"]').attr("checked",true)}$(this).parent().addClass("currentTask");$("#editTask").attr("task_id",$(this).parent().attr("id"));$("#editTask").find("#eTitle").val(a.title);$("#editTask").find("#eComment").val(a.comment);if(a.done){$("#editTask").find("#eDone").attr("checked","checked")}else{$("#editTask").find("#eDone").removeAttr("checked")}$("#eTime").val(a.time);if(a.time){$("#eTimeEnd").timepicker("option","minTime",a.time,"maxTime","23:59").removeAttr("disabled")}else{$("#eTimeEnd").attr("disabled","disabled")}$("#eTimeEnd").val(a.timeEnd);$("#eDate").val(a.date);if(!a.date){$("#eDate").attr("placeholder","---FUTURE---")}$("#editTask").modal("show")})}function initCommentDay(a){$(a).on("click",function(){var a=$(this).parent().siblings("ul:first").attr("date");userEvent("getCommentDay",{date:a});return false})}function initCreateTask(a){$(a).on("keypress",function(a){var b=a.keyCode?a.keyCode:a.which;if(b==13){var c=$(this).val();var d=$(this).parent().parent().siblings("ul").attr("date");if(d=="planned"){d=""}userEvent("create",{title:c,date:d});$(this).val(null);a.preventDefault();return false}})}function initCreateTaskButton(a){$(a).on("click",function(a){var b=$(this).parent().find(".createTask").val();var c=$(this).parent().siblings("ul").attr("date");if(c=="planned"){c=""}userEvent("create",{title:b,date:c});$(this).parent().find(".createTask").val(null)})}function initDrop(a){var b=$("#main").tab();$(a,b).droppable({tolerance:"pointer",accept:".connectedSortable li",hoverClass:"hover",drop:function(a,b){dropped=true;var c=b.draggable.attr("id");var d=$(this).find("a").attr("date");var e=$.trim(b.draggable.children(".time").text());if(d==b.draggable.attr("date")||d=="planned"&&!b.draggable.attr("date")){mesg("Перемещение запрещено","success");return false}if(b.draggable.hasClass("complete")){mesg("Перемещение выполненых задач запрещено","success");return false}b.draggable.addClass("currentTask");userEvent("dragOnDay",{id:c,date:d,time:e})}}).disableSelection()}function initSortable(a){$(a).sortable({tolerance:"pointer",cancel:".ui-state-disabled",opacity:.6,cursor:"move",placeholder:"ui-state-highlight",handle:"span.move",update:function(a,b){if(dropped){$(this).removeAttr("style");$(this).sortable("cancel");dropped=false;return true}if(b.item.parent().attr("date")=="expired"||b.item.parent().attr("date")=="future"||b.item.hasClass("setTime")){mesg("Перемещение запрещено","success");$(this).css("color","");return false}var c=b.item.attr("id");var d=b.item.index()+1;userEvent("changeOrders",{id:c,position:d})},stop:function(a,b){if(dropped){dropped=false;return true}}}).disableSelection()}function initTab(a){$(a).on("shown",function(a){window.location.hash="day-"+a.target.hash.slice(1)})}function initTabDelte(a){$(a).on("click",function(){var a=$(this).parent().attr("date");userEvent("deleteDay",{date:a})})}function initFilter(a){$(a).on("click",function(){var a=$(this).parent().siblings("ul:first");var b=$(this).attr("data");var c=a.children("li").length;a.children("li").removeClass("hide");a.find(".emptyList").addClass("hide");$(this).siblings("a").removeClass("active");switch(b){case"all":$(this).addClass("active");break;case"inProcess":a.children("li.complete").addClass("hide");$(this).addClass("active");if(c&&!a.children("li:not(.complete)").length){if(!a.find(".filterProgress").length){$(".ex_filterProgress").clone().removeClass("ex_filterProgress").removeClass("hide").addClass("filterProgress").appendTo(a)}else{a.find(".filterProgress").removeClass("hide")}}break;case"completed":a.children("li:not(.complete)").addClass("hide");$(this).addClass("active");if(c&&!a.children("li.complete").length){if(!a.find(".filterCompleted").length){$(".ex_filterCompleted").clone().removeClass("ex_filterCompleted").removeClass("hide").addClass("filterCompleted").appendTo(a)}else{a.find(".filterCompleted").removeClass("hide")}}break}return false})}function initDayClick(a){$(a).on("click",function(){var a=$(this).text();userEvent("addDay",{date:a})})}function initPrintClick(a){$(a).on("click",function(){window.print();return false})}function InitClock(){var a=GLOBAL_CONFIG.timezone;var b=new Date;var c=b.getTime()+b.getTimezoneOffset()*6e4+a*36e5;var d=new Date(c);var e=d.getHours();var f=d.getMinutes();var g=d.getSeconds();var h=""+(e<10?"0":"")+e;h+=(f<10?":0":":")+f;h+=(g<10?":0":":")+g;document.getElementById("clock").innerHTML=h;setTimeout("InitClock()",1e3)}function reload(){location.reload()}function showErrorConnection(a){if(!a){setTimeout(checkStatus,+GLOBAL_CONFIG.intervalCheckStatus);$(".connError").addClass("hide");if(connError){reload()}}else{setTimeout(checkStatus,+GLOBAL_CONFIG.intervalCheckStatusError);$(".connError").removeClass("hide");connError=true}}function isDate(a){var b=false;if(a.length){try{$.datepicker.parseDate("yy-mm-dd",a);b=true}catch(c){}}return b}function convertToHtml(a){return $("<div/>").text(a).html()}function convertToText(a){return $("<div/>").html(a).text()}var dropped=false;var countAJAX=0;var connError=false;$(function(){$(window).hashchange(function(a){if(location.hash!=""){var b=location.hash.slice(5);var c=$("#main li.active a").attr("date");if(b==c){return}if(isDate(b)){b=$.datepicker.formatDate("yy-mm-dd",$.datepicker.parseDate("yy-mm-dd",b));userEvent("addDay",{date:b})}else if(b=="future"||b=="expired"||b=="completed"){userEvent("getTasksByType",{type:b});$('#main a[href="#'+b+'"]').tab("show")}else if(b=="planned"){$('#main a[href="#'+b+'"]').tab("show")}else{var d=$.datepicker.formatDate("yy-mm-dd",new Date);location.hash="day-"+d;$('#main a[href="#'+d+'"]').tab("show")}if(b=="future"){$(".agenda").addClass("active");$(".tasks").removeClass("active")}else{$(".agenda").removeClass("active");$(".tasks").addClass("active")}}});$(window).hashchange();$.datepicker.setDefaults($.extend($.datepicker.regional[GLOBAL_CONFIG.dp_regional]));setTimeout(checkStatus,+GLOBAL_CONFIG.intervalCheckStatus);$(".help").tooltip({placement:"left",delay:{show:500,hide:100}});$("#addDay").tooltip({placement:"bottom",delay:{show:500,hide:100}});$("#completed h3").tooltip({placement:"left",delay:{show:500,hide:100}});initTab('#main a[data-toggle="tab"]');initCreateTask(".createTask");initCreateTaskButton(".createTaskButton");initEditAble(".editable");initDelete(".deleteTask");initDone(".done");initRatingDay(".ratingDay input");initEditTask(".editTask");initDrop("ul:first li.drop");initSortable(".sortable");initTabDelte('li a[data-toggle="tab"] .close');initFilter(".filter a");initCommentDay('.days a[data="commentDay"]');initDayClick(".day");initPrintClick(".print");InitClock();$(".daysButton a").click(function(){var a=$(this).attr("date");userEvent("getTasksByType",{type:a})});$("#eTime").timepicker({timeFormat:"HH:mm",maxTime:"23:59",interval:15,startHour:6,change:function(a){$("#eTimeEnd").timepicker("option","minTime",a,"maxTime","23:59").removeAttr("disabled");$(this).removeClass("errorEdit")}});$("#eTimeEnd").timepicker({timeFormat:"HH:mm",maxTime:"23:59",interval:15,change:function(a){$(this).removeClass("errorEdit")}});$("#eDate").datepicker({dateFormat:"yy-mm-dd",showAnim:"clip"});$("#eSave").click(function(){var a=$("#editTask").attr("task_id");var b=$.trim($("#editTask").find("#eTitle").val());var c=$.trim($('input:radio[name="priority"]:checked',"#editTask").val());var d=$.trim($("#editTask").find("#eDone").is(":checked")?1:0);var e=$.trim($("#eDate").val());var f=$.trim($("#eTime").val());var g=$.trim($("#eTimeEnd").val());var h=$.trim($("#eComment").val());userEvent("edit",{id:a,title:b,priority:c,done:d,date:e,time:f,timeEnd:g,comment:h})});$("#eCommentDaySave").click(function(){var a=$("#commentDay").attr("date");var b=$("#eCommentDay").val();userEvent("setCommentDay",{date:a,comment:b})});$("#editTask").on("hidden",function(){scrErrorEdit()});$("#commentDay").on("hidden",function(){scrErrorSetCommentDay()});$("#commentDay textarea, #editTask input, #editTask textarea").change(function(){$(this).removeClass("errorEdit")});$("#addDay").button().click(function(a){var b=$("#dp");b.datepicker({dateFormat:"yy-mm-dd",showAnim:"clip",onSelect:function(a){userEvent("addDay",{date:a})}});if(b.datepicker("widget").is(":hidden")){b.datepicker("show")}else{b.hide()}a.preventDefault()}).disableSelection();$(".addDay").click(function(){$(this).find("li").removeClass("active")});window.onbeforeunload=function(a){if(+countAJAX&&!connError){var b="Содержимое было изменено!\nВы уверены, что хотите покинуть страницу без сохранения?";a=a||window.event;if(a){a.returnValue=b}return b}}})